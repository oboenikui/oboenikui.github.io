<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>単位Falling Down</title>
    <script>
        window.onload = function () {
            var canvas = document.getElementById("can");
            if (!canvas || !canvas.getContext) return false;
            canvas.width = screen.width;
            canvas.height = screen.height;
            var ctx = canvas.getContext("2d");
            var font_name = ctx.font.substring(ctx.font.indexOf("px") + 3, ctx.font.length);
            ctx.fillStyle = "#000";
            var unit_array = ["s", "m", "kg", "A", "K", "mol", "cd", "sr", "Hz", "N", "Pa", "J", "W", "C", "V", "F", "Ω", "S", "Wb", "T", "H", "℃", "lm", "lx", "Bq", "Gy", "Sv", "kat", "￥", "＄"];
            var positions = [];
            var refresh_rate = 30;
            var g = 9.8;
            var move_unit = function (pos) {
                pos.y = pos.y + pos.v;
                pos.v = pos.v + g / refresh_rate;
            }

            var move_all = function () {
                for (var i = 0; i < positions.length; i++) {
                    move_unit(positions[i]);
                    if (positions[i][2] > screen.height) {
                        positions.splice(i, 1);
                    }
                }
            }

            var add_unit = function () {
                var randnum = Math.floor(Math.random() * unit_array.length * 2);
                if (randnum < unit_array.length) {
                    positions.push({ unit: randnum, x: Math.floor(Math.random() * screen.width), y: 0, v: Math.floor(Math.random() * screen.height / refresh_rate), size: Math.floor(Math.random() * screen.height/10)+1 });
                }
            }

            var draw_unit = function (context, pos) {
                context.font = pos.size+"px "+font_name;
                context.fillText(unit_array[pos.unit], pos.x, pos.y);
            }

            var draw_all = function () {
                ctx.clearRect(0, 0, screen.width, screen.height);
                for (var i = 0; i < positions.length; i++) {
                    draw_unit(ctx, positions[i]);
                }
            }
            var timer;
            var delay = 1000/refresh_rate;
            var loop = function () {
                move_all();
                add_unit();
                draw_all();
                clearTimeout(timer);
                timer = setTimeout(loop, delay);
            }
            loop();
        }
        
    </script>
    <style type="text/css" media="screen">
        /* <![CDATA[ */
        div#stage {
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: #FFF;
        }
        /* ]]> */
    </style>
    </head>

    <body>
        <div id="stage">
            <canvas id="can">HTML5非対応のブラウザです</canvas>
        </div>
    </body>
</html>
